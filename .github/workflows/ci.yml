name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  test:
    name: Elixir CI (Elixir ${{ matrix.elixir }} / OTP ${{ matrix.otp }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        elixir: ['1.18', '1.19']
        otp: ['25', '26', '27', '28']
        exclude:
          - { elixir: '1.18', otp: '28' }
          - { elixir: '1.19', otp: '25' }
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ matrix.elixir }}
          otp-version: ${{ matrix.otp }}

      - name: Cache Mix dependencies
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-

      - name: Cache Dialyzer PLT
        uses: actions/cache@v4
        with:
          path: _build/**/*.plt
          key: ${{ runner.os }}-plt-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-plt-${{ matrix.elixir }}-${{ matrix.otp }}-

      - name: Install dependencies
        run: mix deps.get

      # Only check formatting on 1.19+ due to `inputs --` exclude syntax in .formatter.exs
      # See: https://hexdocs.pm/mix/Mix.Tasks.Format.html#module-formatting-options
      - name: Check code format
        if: matrix.elixir == '1.19'
        run: mix format --check-formatted

      - name: Run Credo
        run: mix credo --strict

      - name: Run tests
        run: mix test

      - name: Run Dialyzer
        run: mix dialyzer --format github

      - name: Convert fixtures to EPUB
        if: matrix.elixir == '1.19' && matrix.otp == '27'
        run: mix run bin/convert_fixtures_to_epub.exs epub_output

      - name: Upload EPUB artifacts
        if: matrix.elixir == '1.19' && matrix.otp == '27'
        uses: actions/upload-artifact@v4
        with:
          name: epub-output
          path: epub_output/
          retention-days: 7

  blocknote:
    name: BlockNote JSON validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v2
      - name: Validate BlockNote JSON with official library
        run: deno run --allow-read --allow-env .ci/main.ts $(find test/snapshots/DocSpec.BlockNote.Writer -name 'expected.json')

  epubcheck:
    name: EPUBCheck validation
    runs-on: ubuntu-latest
    needs: test
    continue-on-error: true
    env:
      EPUBCHECK_VERSION: "5.3.0"
    steps:
      - name: Download EPUB artifacts
        uses: actions/download-artifact@v4
        with:
          name: epub-output
          path: epub_output/

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Download EPUBCheck
        run: |
          curl -SL "https://github.com/w3c/epubcheck/releases/download/v${EPUBCHECK_VERSION}/epubcheck-${EPUBCHECK_VERSION}.zip" -o epubcheck.zip
          unzip -q epubcheck.zip

      - name: Run EPUBCheck
        run: |
          set -euo pipefail
          for f in epub_output/*.epub; do
            printf '\n=== %s ===\n' "$f"
            java -jar "epubcheck-${EPUBCHECK_VERSION}/epubcheck.jar" --failonwarnings "$f" || true
          done
